<!DOCTYPE HTML>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
.tooltip {
  position: relative;
  display: inline-block;
  border-bottom: 1px dotted black;
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: 160px;
  height:220px;
  font-size: 8pt;
  background-color: #555;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px 0;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -60px;
  opacity: 0;
  transition: opacity 0.3s;
}

.tooltip .tooltiptext::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 30%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #555 transparent transparent transparent;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}
header {
    background:#333;
    color:#eee;
    width:100%;
}

input#abrir-cerrar {
    visibility:hidden;
    position: absolute;
    top: -9999px;
}


label[for="abrir-cerrar"] {
    cursor:pointer;
    padding: 1rem;
    background-color:#333;
    color:#fff;
    display:inline-block;
    width:200%;

}

.cerrar {
    display:none;
}

#sidebar {
    width:0;
}

#contenido {
    margin-left:0;
}
#container-project{
    margin-left:0;
}

input#abrir-cerrar:checked ~ #sidebar {
    width:206px;
}

input#abrir-cerrar:checked + label[for="abrir-cerrar"], input#abrir-cerrar:checked ~ #contenido {
    margin-left:206px;
    transition: margin-left .4s;
}
input#abrir-cerrar:checked + label[for="abrir-cerrar"], input#abrir-cerrar:checked ~ #container-project {
    margin-left:206px;
    transition: margin-left .4s;
}

input#abrir-cerrar:checked + label[for="abrir-cerrar"] .cerrar {
    display:inline;
}

input#abrir-cerrar:checked + label[for="abrir-cerrar"] .abrir {
    display:none;
}
.name{
    width: 120px;
}
.sidebar {
    position: fixed;
    height: 100%;
    width: 0;
    top: 0;
    left: 0;
    z-index: 1;
    background-color: #00324b;
    overflow-x: hidden;
    transition: 0.4s;
    padding: 1rem 0;    
    box-sizing:border-box;
}

.sidebar .boton-cerrar {
    position: absolute;
    top: 0.5rem;
    right: 1rem;
    font-size: 2rem;
    display: block;
    padding: 0;
    line-height: 1.5rem;
    margin: 0;
    height: 32px;
    width: 32px;
    text-align: center;
    vertical-align: top;
}

.sidebar ul, .sidebar li{
    margin:0;
    padding:0;
    list-style:none inside;
}


h1 {
    color:#f90;
    font-size:180%;
    font-weight:normal;
}
#contenido {
    transition: margin-left .4s;
    padding: 1rem;
}
#container-project{
    transition: margin-left .4s;
    padding: 1rem;
}
.abrir-cerrar {
    color: #2E88C7;
    font-size:1rem;   
}
button{
    background-color: #006080;
    color:white;
}
body{
    background-color: #ffffff;
    border:0;
    margin:0;
}
.totales{
    background-color: #cccccc;
    vertical-align: top;
    padding: 6px;
}
input{
    font-family: Arial, Helvetica, sans-serif;
    font-size: 9pt;  
}
.cardmini{
    font-family: Arial, Helvetica, sans-serif;
    font-size: 9pt;
    width: 98%;
}
.bad{
    background-color: red;
    color: white;
    border: 1px solid white;
}
span.nb{
    display:inline-block;
    width:150px;
}
th{
    font-family: Arial, Helvetica, sans-serif;
    color:white;
    font-size: 12pt;
}
input{
    border:1px solid lightgray;
}
input.dedi{
    display:inline-block;
    width:20px;
}
.good{
    background-color: green;
    color: white;
    border: 1px solid white;
    display:none;
}
.mes{
    background-color: #cccccc;
    height: 100%;
    padding-top: 2px;
    padding-bottom: 10px;
}
#team{
    background-color: black;
    height: 100%;
    padding: 3px;
    width: 200px;
    margin: 2pxpx;
}
.teamWrapper{
    display: none;
}
.sidebar::-webkit-scrollbar {
    display: none;  /* Ocultar scroll */
}
.card{
    border:1px solid lightgray;
    display: block;
    margin-top: 4px;
    margin-bottom: 4px;
    padding-top: 2px;
    padding-bottom: 2px;
    padding-left: 2px;
    font-family: Arial, Helvetica, sans-serif;
    font-size: 8pt;
    background-color: #e6f9ff;
}
.properties{
    font-family: Verdana, Geneva, Tahoma, sans-serif;
    font-size: 12pt;
}
.carddup{
    border:1px solid lightgray;
    margin-top: 4px;
    margin-bottom: 4px;
    padding-top: 2px;
    padding-bottom: 2px;
    background-color: dimgrey;
}
.proyecto {
  width: 200px;
  margin: 10px;
  padding: 10px;
  border: 1px solid silver;
  vertical-align: top;
  font-family: Arial, Helvetica, sans-serif;
  font-size: 9pt;
  background-color: white;
  color:#006080;
}
#div1, #div2, #div4, #div5 {
  width: 200px;
  height: 235px;
  margin: 10px;
  padding: 10px;
  border: 1px solid black;
  vertical-align: top;
}
table.paleBlueRows {
  font-family: Verdana, Geneva, Tahoma, sans-serif;
  border: 1px solid #FFFFFF;

  text-align: center;
  border-collapse: collapse;
}
table.paleBlueRows td, table.paleBlueRows th {
  border: 1px solid #FFFFFF;
  padding: 3px 2px;
}
table.paleBlueRows tbody td {
  font-size: 13px;
}
table.paleBlueRows tr:nth-child(even) {
  background: #D0E4F5;
}
table.paleBlueRows thead {
  background: #0B6FA4;
  color:#FFFFFF;
  border-bottom: 5px solid #FFFFFF;
}
table.paleBlueRows thead th {
  font-size: 17px;
  font-weight: bold;
  color: #FFFFFF;
  text-align: center;
  border-left: 2px solid #FFFFFF;
}
table.paleBlueRows thead th:first-child {
  border-left: none;
}

table.paleBlueRows tfoot {
  font-size: 14px;
  font-weight: bold;
  color: #333333;
  background: #D0E4F5;
  border-top: 3px solid #444444;
}
table.paleBlueRows tfoot td {
  font-size: 14px;
}
</style>
<script>
var globId=1;
const GOODTHRESHOLD=100;
//var INITIALMONTH=new Date().getMonth()+1; <-- esta es la correcta
var INITIALMONTH=new Date().getMonth();
var MONTHTOSHOW=12;
var INITIALYEAR=new Date().getFullYear();
var YEARTOSHOW=new Date().getFullYear()+1;
console.log(INITIALYEAR,YEARTOSHOW);
cantidad=10
titulo=["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]
// arreglos globales
var dataArr=[];
var mesStruct=Array.from({length: 24}, function() { return ""; });
var teamStruct=[]
var projStrtSumm=[]
var factprojmonthy=[]
function allowDrop(ev) {
  ev.preventDefault();
}
function createBaseTable() {
  var x = document.createElement("TABLE");
  x.setAttribute("id", "tmeses");

  document.getElementById("contenido").appendChild(x);

  var nombres = document.createElement("TR"); // el encabezado con los nombres de los meses
  nombres.setAttribute("id", "titulo");
  document.getElementById("tmeses").appendChild(nombres);
  for(let i=INITIALMONTH;i<INITIALMONTH+MONTHTOSHOW;i++){
        var z = document.createElement("TD");
        var numes=i-1;
        if(i>12){
            numes=i-12-1;
            //console.log(numes,titulo[numes]);
        }
        var t = document.createTextNode(titulo[numes]);
        z.appendChild(t);
        document.getElementById("titulo").appendChild(z);
  }
  var totales = document.createElement("TR"); // area de totales
  totales.setAttribute("id", "totales");
  document.getElementById("tmeses").appendChild(totales);
  for(let j=INITIALMONTH;j<INITIALMONTH+MONTHTOSHOW;j++){
        var td = document.createElement("TD");
        td.setAttribute("class", "totales");
        var numes=j;
        //if(j>12) numes=j-12-1
        var div = document.createElement("DIV")
        let titulodiv="mes"+numes+"totales"
        div.setAttribute("id", titulodiv);
        td.appendChild(div);
        document.getElementById("totales").appendChild(td);
  }
  var detalle = document.createElement("TR"); // area de detalle
  detalle.setAttribute("id", "detalle");
  document.getElementById("tmeses").appendChild(detalle);
  for(let k=INITIALMONTH;k<INITIALMONTH+MONTHTOSHOW;k++){
        var td = document.createElement("TD");
        td.setAttribute("style", "vertical-align: top;");
        var numes=k;
        //if(j>12) numes=j-12-1
        var div = document.createElement("DIV")
        let titulodiv="mes"+numes
        div.setAttribute("id", titulodiv);
        div.setAttribute("class", "mes");
        td.appendChild(div);
        document.getElementById("detalle").appendChild(td);
  }  
}
function dup(elem,data){
    try{
    	var el=document.getElementById(data);
        var proy=document.getElementById(elem);
        var h=proy.style.height;
        var hh=h.replace("px","");
        var hh=parseInt(hh)+50;
        //proy.style.height=hh+"px";
        var nb=el.childNodes[1].value;
        var por=el.childNodes[3].value;
		var div=document.createElement("div");
        div.id="d"+data+globId;
        globId=globId+1;
        var inp=document.createElement("input");
        inp.type="text";
        inp.value=nb;
		var inp2=document.createElement("input");
        inp2.type="text";
        inp2.value="0%";
        div.draggable="true";
        div.className="carddup";
        div.ondragstart=drag;
        div.appendChild(inp);
        div.appendChild(inp2);
        document.getElementById(elem).appendChild(div)
    }catch(err){
    	alert(err);
    }    
}

function drag(ev) {
  ev.dataTransfer.setData("text", ev.target.id);
  document.getElementById("div3").innerHTML =document.getElementById("div3").innerHTML+document.getElementById(ev.target.id).parentNode.id+" " +ev.target.id+","
}

function agregarTotal(mes,nombre,dedica){
    //console.log("Agregar total")
    var id="mes"+parseInt(mes)+"totales";
    //console.log(mes);
    //console.log(nombre);
    mesStruct[mes-1].persona.push({nombre:nombre,dedicacion:0});
    //console.log(mesStruct);
    var estrucTot=document.getElementById(id);
    var div=document.createElement("div");
    var clase="good";
    div.className="cardmini "+clase;                    
    //var texto=document.createTextNode(pers[p].nombre+" -->"+pers[p].dedicacion);
    var sp1=document.createElement("span");
    var sp2=document.createElement("input");
    var sp3=document.createElement("span");
    var nb=document.createTextNode(nombre);
    //var dedica=document.createTextNode(pers[p].dedicacion);
    var por=document.createTextNode("%");
    sp1.appendChild(nb);
    //sp2.appendChild(dedica);
    sp2.value="0"
    sp3.appendChild(por);
    sp1.className="nb";
    sp1.readOnly="true";
    sp2.className="dedi";
    sp2.id="sp-"+nombre+"-"+mes;
    div.appendChild(sp1);
    div.appendChild(sp2);
    div.appendChild(sp3);
    estrucTot.appendChild(div);
}
function drop(ev) {
	try{
      ev.preventDefault();
      var idPersona=ev.target.childNodes[1].id;
      //console.log("drop ",ev.target.id);
      var arr=ev.target.id.split('.');
      var mes=arr[2];
      var proj=arr[0];
      var phase=arr[1];
      var cod=idPersona.split('-');
      var proyid=cod[2];
      var data = ev.dataTransfer.getData("text");
      var nuevo=document.getElementById(data)
      var separa=nuevo.id.split('-');
      var nombre=separa[1];
      var inOnSite="0";
      //console.log("separa",separa)
      //console.log("sp-"+separa[1]+"-"+mes);
      if(document.getElementById("sp-"+separa[1]+"-"+mes)==null){
          //console.log("No existe el total. Hay que reconstruirlo");
          agregarTotal(mes,nombre,0)
      }      
      nuevo.id=separa[0]+"-"+nombre+"-"+proyid;
      if(separa[0]=="t"){
            //var bott=document.getElementById("b-"+separa[1]);
            //console.log("el boton",bott);
            //console.log("nuevo id",separa[1]+"-"+proj+"."+mes+"-"+mes);
            //console.log("id",nombre+"-"+proj+"."+phase+"."+mes+"-"+mes);          
           // bott.id=nombre+"-"+proj+"."+phase+"."+mes+"-"+inOnSite;
           // bott.name=nombre+"-"+proj+"."+phase+"."+mes+"-"+inOnSite;
            nuevo.id=separa[0]+"-"+nombre+"-"+proj+"."+phase+"."+mes+"-"+inOnSite;
            var check = document.createElement("INPUT");
            check.id="cb-"+nombre+"-"+proj+"."+phase+"."+mes+"-"+inOnSite;
            check.setAttribute("type", "checkbox");
            nuevo.appendChild(check);
      }
      ev.target.appendChild(nuevo);
      var h=ev.target.style.height;
      var hh=h.replace("px","");
      var hh=parseInt(hh)+50;
      ev.target.style.height=hh+"px"
      var el=document.getElementById(nuevo.id)
      addElementIntoTeamStruct(data);
      for(let c in el.childNodes){              
            let name=el.childNodes[c].name;   
            if(typeof name!="undefined" ){
                //console.log("name",name);
                if(name==nombre){
                    el.childNodes[c].id="id-"+nombre+"-"+proj+"."+phase+"."+mes+"-"+inOnSite;
                    document.getElementById(el.childNodes[c].id).addEventListener("change", function() {
                        //console.log("onChange",nombre+proj+phase+mes);
                        var datname=this.name;
                        var datvalue=this.value;
                        //console.log("onChange id",this.id);
                        //var proy=datname[1].split(".");
                        //console.log("proy",proy);         
                        var datid=this.id;
                        var sep=datid.split("-");
                        var checkid="cb-"+sep[1]+"-"+sep[2]+"-"+inOnSite;
                        var wrappid="t-"+sep[1]+"-"+sep[2]+"-"+inOnSite;
                        //console.log("check ",document.getElementById(checkid));
                        if(document.getElementById(checkid)!==null){
                            if(document.getElementById(checkid).checked){
                                //console.log("wrappid",wrappid);
                                //console.log(document.getElementById(wrappid))
                                document.getElementById(wrappid).style.backgroundColor="blue";
                                inOnSite=1;
                            }else{
                                document.getElementById(wrappid).style="";
                                inOnSite=0;
                            }
                        }
                        //console.log("va a recalcular",mes);
                        recalcular(mes);             
                        //console.log("antes de setNewDedication inOnSite",inOnSite)                          
                        setNewDedication(proj,phase,mes,nombre,inOnSite,datvalue);
                        inOnSite=0;
                    });
                }
                let part=name.split("-");
                if(part[0]=="f" || part[0]=="b"){    
                    //console.log("borrar",el.childNodes[c])                         
                    elemt=el.childNodes[c];
                    elemt.remove();                    
                }
            }  
          }
  	}catch(err){ 
          console.log(err);
    }
}
function drop2(ev) {
  ev.preventDefault();
  var data = ev.dataTransfer.getData("text");
  //console.log("al trash",data);
  ev.target.appendChild(document.getElementById(data));
  let elemt=document.getElementById(data);
  alert("se eliminará permanentemente");
  elemt.remove()
}
function setVisibilityToProy(nb,filtrar){
    //console.log("filtrar",nb)
    var arr=document.getElementsByClassName("proyecto");
    var disp="block"
    if(filtrar){
        disp="none"
    }
    for(let i in arr){        
        if( typeof arr[i].id !="undefined") arr[i].style.display=disp;
    }
    if(filtrar){
        for(let j in dataArr){
            if(INITIALYEAR<=dataArr[j].year && YEARTOSHOW>=dataArr[j].year && dataArr[j].mes>=INITIALMONTH && dataArr[j].mes<=INITIALMONTH+MONTHTOSHOW){
                var idProj=dataArr[j].IDp+"."+dataArr[j].fase+"."+dataArr[j].mes;
                var team=dataArr[j].equipo;
                //console.log("buscando en",team)
                for(let k in team){

                    if(team[k].nombre==nb){
                        //console.log("comprobado. nombre",nb)
                        var div=document.getElementById(idProj);
                        div.style.display="block"
                    }
                }
            }
        }
    }
}
function setDataProy(id,proy,fase,mes,hr){
    return {
        IDp:id,
        proyecto: proy,
        fase:fase,
        mes:mes,
        horas:hr,
        equipo:[]
    }
}
function setDataTeam(nombr,dedica){
    return {
        name:nombr,
        dedicacion:dedica
    }
}
function BotonDuplicar(pid, m, nb, inOnSite){
    //console.log("pid",pid);
    var proy=document.getElementById(pid);
    var wrp=document.getElementById("w-"+pid);
    var person=document.getElementById(m);
    var div=document.createElement("div");        
    div.id="d-"+nb+"-"+pid+"-"+m;
    globId=globId+1;
    var inp=document.createElement("input");
    inp.type="text";
    inp.readOnly="true";
    inp.value=nb;
    inp.name="nombre";
    var inp2=document.createElement("input");
    inp2.type="text";
    inp2.value="0";
    inp2.name=nb;
    inp2.style.width="20px";
    div.draggable="true";
    div.className="carddup";
    div.ondragstart=drag;
    div.appendChild(inp);
    div.appendChild(inp2);
    wrp.appendChild(div);
}
function showProperties(bar,param){
    var params=param.split(".");
    var firstParam=params[0].split("-");
    var idpParam=firstParam[1];
    var fasePara=params[1];
    var mesParam=params[2];
    console.log("params",param)
    bar.style.width="400px";
    bar.style.padding="4px";
    bar.style.marginLeft=(window.innerWidth-400)+"px"
    bar.style.height=(window.window.innerHeight)+"px"
    var contentBar=document.createElement("DIV");
    contentBar.className="properties";
    var contentProperties=document.createElement("DIV");
    var textTitleBar;
    
    var existe=false;
    //console.log("dataArr",dataArr);
    var tabProperties="<table class='paleBlueRows'><thead><tr><th>Nombre</th><th>On Site<th>Dedicación</th><th>Original</th></tr></thead><tbody>";
    for(let i in dataArr){
        if(dataArr[i].fase==fasePara && dataArr[i].IDp==idpParam){
            if((dataArr[i].year>INITIALYEAR && dataArr[i].mes+12==mesParam)||(dataArr[i].year==INITIALYEAR && dataArr[i].mes==mesParam) ){
                existe=true;
                let mesProp=dataArr[i].mes>12?dataArr[i].mes+"("+(dataArr[i].mes-12)+")":dataArr[i].mes
                textTitleBar=dataArr[i].IDp+" "+dataArr[i].proyecto+"<br> Fase:"+dataArr[i].fase+"<br> Mes :"+mesProp+"<br> Año :"+dataArr[i].year+"<br><hr><br>";
                let teamProp=dataArr[i].equipo;
                for(let j in teamProp){
                    let onsite=teamProp[j].inOnSite==1?"Si":"No"
                    tabProperties=tabProperties+`<tr><td>${teamProp[j].nombre}</td><td>${onsite}</td><td>${teamProp[j].dedicacion}</td><td>${teamProp[j].original}</td></tr>`
                }
            }
        }
    }
    if(existe){
        tabProperties=tabProperties+"</tbody></table><br><hr>";
        contentProperties.innerHTML=tabProperties;
        contentBar.innerHTML=bar.innerHTML.indexOf("PROPERTIES VIEW")>=0?textTitleBar:"<h3>PROPERTIES VIEW</h3>"+textTitleBar;
        bar.appendChild(contentBar);
        bar.appendChild(contentProperties);
        
    }
}
function buildProject(dtaArr){
    //console.log("En buildProject",dtaArr);
    //console.log("year",INITIALYEAR);
    dataArr=dtaArr;    
    for(let i in dataArr){
        dataArr[i].dirty=0;
        var currMo=dataArr[i].mes;
        var currYear=dataArr[i].year;
        var diffYears=currYear-INITIALYEAR;
        var idMo=currMo+diffYears*12; 

        if(INITIALYEAR<=dataArr[i].year && dataArr[i].year<=YEARTOSHOW && idMo>=INITIALMONTH && idMo<=INITIALMONTH+MONTHTOSHOW){            

            //console.log("mes",currMo);
            //console.log(currYear,idMo);
            var contenedor=document.getElementById("mes"+idMo);       
            var divProy=document.createElement("div");
            divProy.id=dataArr[i].IDp+"."+dataArr[i].fase+"."+idMo;
            var projId=divProy.id;
            var divTeamWrap=document.createElement("div");
            divTeamWrap.className="teamWrapper"; 
            divProy.style.height=dataArr[i].equipo.length*100;
            divProy.className="proyecto";
            
            teamArr=dataArr[i].equipo;
            var teamText=" (";
            var teamTooltip=" - "
            var totDedicaProy=0.0;
            for(let ii in teamArr){
                teamText=teamText+ teamArr[ii].nombre;
                teamTooltip=teamTooltip+" "+teamArr[ii].nombre+" ("+teamArr[ii].dedicacion+") ";
                totDedicaProy=totDedicaProy+Number(parseFloat(teamArr[ii].dedicacion).toFixed(2))
            }
            const sp=String.fromCharCode(160);
            var sep=document.createElement("span");
            var separa=document.createTextNode(sp+sp+"cambio por:"+sp+sp);
            var frameTotal=document.createElement("span");
            frameTotal.style.color="green";
            var totalProj=document.createTextNode(totDedicaProy.toFixed(2));
            frameTotal.appendChild(totalProj);
            var changed=document.createElement("span");
            changed.style.color="orange";
            changed.id="chg-"+divProy.id;
            var totalChg=document.createTextNode("");            
            changed.appendChild(totalChg);

            teamText=teamText+")";
            teamTooltip=teamTooltip+" - ";
            teamTooltip=dataArr[i].IDp+"-"+dataArr[i].proyecto+"   - Team: "+teamTooltip;
            var nodeTexto=dataArr[i].IDp+"-"+dataArr[i].proyecto.substring(0,28)+"... fase "+dataArr[i].fase+" mes "+dataArr[i].mes+" año "+dataArr[i].year+" ";
            var texto=document.createTextNode(nodeTexto);
            var divtooltip=document.createElement("div");
            divtooltip.className="tooltip"
            var divTooltipTxt=document.createElement("span");
            divTooltipTxt.className="tooltiptext";
            var textoTooltips=document.createTextNode(teamTooltip);
            var hover=document.createTextNode("[Info]-");        
            divTooltipTxt.appendChild(textoTooltips);
            divtooltip.appendChild(hover);
            divtooltip.appendChild(divTooltipTxt);
            divProy.appendChild(texto);
            divProy.appendChild(divtooltip);
            divProy.ondrop=drop;
            divProy.ondragover=allowDrop;
            var botonw=document.createElement("button");
            botonw.type="button";
            botonw.name="bw-"+projId;  
            botonw.id="bw-"+projId; 
            var textow=document.createTextNode("v");
            botonw.appendChild(textow);
            divProy.appendChild(botonw);
            divProy.appendChild(frameTotal);
            divProy.appendChild(separa);
            divProy.appendChild(changed);
            
            for(let j in teamArr ){
                var div=document.createElement("div");
                div.id="c-"+teamArr[j].nombre+"-"+dataArr[i].IDp+"."+dataArr[i].fase+"-"+idMo;
                var consId=div.id;
                globId=globId+1;
                var inp=document.createElement("input");
                inp.type="text";
                inp.name="nombre"
                inp.readOnly="true";
                inp.style.width="120px";
                inp.value=teamArr[j].nombre;
                var inp2=document.createElement("input");
                inp2.type="text";
                inp2.style.width="39px"
                inp2.name=teamArr[j].nombre+"-"+projId+"-"+idMo+"-"+teamArr[j].inOnSite;
                inp2.id="id-"+teamArr[j].nombre+"-"+projId+"-"+idMo+"-"+teamArr[j].inOnSite;
                var newDedi=teamArr[j].newDedi;
                if(!isNaN(newDedi))
                    teamArr[j].dedicacion=newDedi;
                if(isNaN(teamArr[j].original))
                    teamArr[j].original=0;
                inp2.value=teamArr[j].dedicacion;
                
                if(parseInt(teamArr[j].dedicacion)>0){
                    div.draggable="";
                    //console.log("No draggable",div.id);
                }else{
                    //console.log("es draggable",parseInt(teamArr[j].dedicacion));
                    div.draggable="true";
                    div.ondragstart=drag;
                }
                    
                div.className="card";
                //console.log("inOnSite",teamArr[j].inOnSite);
                if(teamArr[j].inOnSite==1){
                    div.style.backgroundColor="blue";
                }
                
                div.appendChild(inp);
                div.appendChild(inp2);
                
                var boton=document.createElement("button");
                boton.type="button";
                boton.name=teamArr[j].nombre+"-"+projId+"-"+idMo+"-"+teamArr[j].inOnSite;
                boton.id=teamArr[j].nombre+"-"+projId+"-"+idMo+"-"+teamArr[j].inOnSite;
                var texto2=document.createTextNode("+");
                boton.appendChild(texto2);
                //div.appendChild(boton);
                //divProy.appendChild(div);
                divTeamWrap.appendChild(div);
                divTeamWrap.id="w-"+projId;                      
                divProy.appendChild(divTeamWrap);  
                contenedor.appendChild(divProy);
                /*document.getElementById(boton.id).addEventListener("click", function() {
                    var dat=this.name.split("-");
                    BotonDuplicar(dat[1], dat[2], dat[0],dat[3]);
                });*/
                document.getElementById(inp2.id).addEventListener("change", function() {
                    var datname=this.name.split("-");
                    var datvalue=this.value;
                    //console.log("onChange",datvalue);
                    var proy=datname[1].split(".");
                    //console.log("proy",proy);
                    //console.log("onChange",datname);
                    //console.log("va a recalcular",proy[2]);
                    recalcular(proy[2]);                        
                    setNewDedication(proy[0],proy[1],proy[2],datname[0],datname[3],datvalue);
                    if(parseInt(datvalue)==0){
                        // armar el id tomando el datname y actualizar 
                        //  
                        console.log("en onchange",datname);
                    }
                });
            
            }  
            document.getElementById(botonw.id).addEventListener("click", function() {
                    var dat=this.name.split("-");
                    var ht=0;
                    let wrp=document.getElementById("w-"+dat[1]);
                    let prj=dat[1].split(".");
                    //console.log("display",wrp.style.display.length);
                    let bwrp=document.getElementById("bw-"+dat[1]);
                    let bar=document.getElementById("bar")
                    if(wrp.style.display=="none"||wrp.style.display.length==0){
                        wrp.style.display="block";
                        showProperties(bar,this.name);
                        bwrp.innerHTML="i";
                        ht = parseInt(fillProjSumm(prj[0]));
                        ht = ht + 40;
                        document.getElementById("div-content-head").style.height=ht+"px";
                        mostrarProyMonthly(prj[0]);
                    }else{
                        wrp.style.display="none";
                        bar.style.width="0";
                        bar.style.height="0";
                        bar.style.padding="0";
                        bar.innerHTML="";
                        bwrp.innerHTML="v";
                        var content = document.getElementById("container-project");
                        content.style.display="none"
                        var tabla=document.getElementById("projSumm");
                        tabla.innerHTML = "";
                        document.getElementById("div-content-head").style.height="120px";
                        mostrarProyMonthly(0);
                        let btn=document.getElementById("btn-both");
                        btn.textContent="Project View & Staffing View";
                        
                    }
                });  
        }
    }
    //console.log(dataArr);
}
function getMonStruct(nb,mes){
    for(let i in mesStruct[mes-1].persona){
        if(mesStruct[mes-1].persona[i].nombre==nb){
            //console.log("mesStruct[mes-1].persona[i].dedicacion",mesStruct[mes-1].persona[i].dedicacion)
            return mesStruct[mes-1].persona[i].dedicacion;
        }
    }  
}
function actualizarDatos(mes){
    var divmes=document.getElementById("mes"+mes+"totales");
    //console.log("divmes",divmes);
    for(let h in divmes.childNodes){
        if(divmes.childNodes[h].className=="cardmini bad" || divmes.childNodes[h].className=="cardmini good"){
            var nodeTot=divmes.childNodes[h].childNodes;
            for(let k in nodeTot){
                if(nodeTot[k].className=="dedi"){
                    //console.log("id--",nodeTot[k].id);
                    var parms=nodeTot[k].id.split("-");
                    //console.log("params",parms);
                    var tot=parseInt(getMonStruct(parms[1],parms[2]));
                    //console.log("tot",tot)
                    if(parseInt(tot)>GOODTHRESHOLD){
                        document.getElementById(nodeTot[k].id).value=tot;
                        divmes.childNodes[h].className="cardmini bad"
                    }else{
                        document.getElementById(nodeTot[k].id).value=tot;
                        divmes.childNodes[h].className="cardmini good"
                    }
                }
            }
        }
    }
}
function setMonStruct(nb,dedica,mes){
    for(let i in mesStruct[mes-1].persona){
        if(mesStruct[mes-1].persona[i].nombre==nb){
            var t=mesStruct[mes-1].persona[i].dedicacion;
            mesStruct[mes-1].persona[i].dedicacion=parseInt(t)+parseInt(dedica);
        }
    }  
}
function cleanMonStruct(mes){
    for(let i in mesStruct[mes-1].persona){
        mesStruct[mes-1].persona[i].dedicacion="0";
    }    
}
function setNewDedication(proy,fase,mes,usr_name,inOnSite,usr_dedic){
    // buscar el proyecto
    //console.log("setNewDedication-parametros",mes);
    //console.log("setNewDedication-parametros",proy+"-"+fase+"-"+usr_name+"-"+usr_dedic);
    //console.log("dataArr",dataArr);
    var pmes=mes;
    //if(parseInt(mes)>12) pmes=parseInt(mes)-12;
    var existe=false;
    for(let i in dataArr){
        if(dataArr[i].IDp==proy && dataArr[i].fase==fase && dataArr[i].mes==pmes){
            dataArr[i].dirty=1;
            var totChg=0.0;
            var totOrig=0.0;
            var totDed=0.0
            for(let j in dataArr[i].equipo){
                // se existe, se cambia.Sino se agrega
                totOrig=totOrig+parseFloat(dataArr[i].equipo[j].original);
                totDed=totDed+parseFloat(dataArr[i].equipo[j].dedicacion);
                if(usr_name==dataArr[i].equipo[j].nombre && dataArr[i].equipo[j].inOnSite==inOnSite){
                    existe=true;
                    dataArr[i].equipo[j].dedicacion=usr_dedic;
                    //console.log("setNewDedication 1",usr_dedic);
                }
                totChg=totChg+parseFloat(dataArr[i].equipo[j].dedicacion);
            }
            if(!existe){
                var newUsr={nombre:"",dedicacion:"",original:0, inOnSite:0}
                newUsr.nombre=usr_name;
                newUsr.dedicacion=usr_dedic;
                newUsr.inOnSite=inOnSite;
                //console.log("setNewDedication 2",usr_dedic);
                //console.log("setNewDedication 2",newUsr.dedicacion);
                dataArr[i].equipo.push(newUsr);
                totChg=totChg+parseFloat(usr_dedic);
            }
        }
    } 
    //console.log("datarr-->",dataArr);
    var id="chg-"+proy+"."+fase+"."+mes
    var totChngEnPag=document.getElementById(id);
    //console.log("id del total chg",id)
    //console.log("valor",totChg);
    //console.log("orig",totOrig);
    //console.log("totDed",totDed);
    var color="orange";
    if(totOrig.toFixed(2)==totChg.toFixed(2)) {
        //console.log(totChg.toFixed(2),totOrig.toFixed(2));
        color="orange";
    }else{
        //console.log(totChg.toFixed(2),totOrig.toFixed(2));
        color="red";
    } 

    //console.log("color",color);
    totChngEnPag.innerText=totChg.toFixed(2);
    totChngEnPag.style.color=color;
}
function sumarEnTeamW(teamW,m){
    //console.log("en SumarEn",m)
    for(let k in teamW){
        if(teamW[k].className=="card" || teamW[k].className=="carddup"){
            //console.log("proy",proylist[j]);
            var textos=teamW[k].childNodes;
            var cons=[];
            var ded=[];
            for(let l in textos){
                if(textos[l].type=="text" && textos[l].name!="nombre"){  
                    var dup=textos[l].name.split('-');      
                    //console.log("text",textos[l].id);                    
                    //console.log("text",textos[l].value);
                    //console.log("mes",m.substring(3))
                    setMonStruct(dup[0],textos[l].value,m.substring(3));
                    //console.log("mes struct",mesStruct);
                }
            }
        }
    }
}
function sumarEnInputs(inputs,m){
    //console.log("en SumarEnInputs",m)

    for(let k in inputs){
        if(inputs[k].type=="text" && inputs[k].name!="nombre"){  
            var dup=inputs[k].name.split('-');      
            //console.log("input text",inputs[k].id);                    
            //console.log("input text",inputs[k].value);
            //console.log("mes",m.substring(3))
            setMonStruct(dup[0],inputs[k].value,m.substring(3));
            //console.log("input mes struct",mesStruct);
        }
    }

}
function recalcular(m){
    if(!isNaN(m))
        m="mes"+m;
    //console.log("recalcular",m)
    var hijos=document.getElementById(m).childNodes;
    //console.log("hijos",hijos);
    cleanMonStruct(m.substring(3));
    for(let i in hijos ){
        if(typeof hijos[i].id != 'undefined'){
            if(hijos[i].className=="proyecto"){
                //console.log("en proyecto",hijos[i].id)
                var proylist=hijos[i].childNodes;
                for(let j in proylist){
                    //console.log("en proylist",proylist[j].className);
                    if(typeof proylist[j].className != 'undefined' && (proylist[j].className=="card" || proylist[j].className=="carddup")){
                        //console.log("card",proylist[j].name);
                        //console.log("card",proylist[j].id);
                        var inputs=proylist[j].childNodes;
                        //console.log("inputs",inputs);
                        sumarEnInputs(inputs,m); 

                    }
                    if(typeof proylist[j].className != 'undefined' && proylist[j].className=="teamWrapper"){
                        //console.log("teamWrapper",proylist[j]);
                    
                        var teamW=proylist[j].childNodes;
                        sumarEnTeamW(teamW,m);                        
                    }
                }
            }
        }         
    }
    //console.log("mesStruct",mesStruct);
    actualizarDatos(m.substring(3));
}
function createMonStruct(datarr){
    //mesStruct=Array.from({length: 12}, function() { return ""; });
    //console.log("initial",INITIALMONTH);
    //console.log("a mostrar",MONTHTOSHOW);
    for(let i in datarr){
        var currMo=dataArr[i].mes;
        var currYear=dataArr[i].year;
        var diffYears=currYear-INITIALYEAR;
        var idMo=currMo+diffYears*12;        
        if(INITIALYEAR<=dataArr[i].year && dataArr[i].year<=YEARTOSHOW && idMo>=INITIALMONTH && idMo<=INITIALMONTH+MONTHTOSHOW){ 
        //if(INITIALYEAR==dataArr[i].year && dataArr[i].mes>=INITIALMONTH && dataArr[i].mes<=INITIALMONTH+MONTHTOSHOW){
            //console.log("mes",dataArr[i].mes);
            //console.log("idMo",idMo);
            //var m=datarr[i].mes-1;
            var m=idMo-1;
            var vacio=true;
            var esta=false;
            if(mesStruct[m]== "")
                mesStruct[m]={mes:m+1,persona:[]}
            for(let j in datarr[i].equipo ){
                vacio=true;
                esta=false;
                try{
                for(let k in mesStruct[m].persona){
                    vacio=false;
                    if(mesStruct[m].persona[k].nombre==datarr[i].equipo[j].nombre){
                        var deda=mesStruct[m].persona[k].dedicacion;
                        var dedb=datarr[i].equipo[j].dedicacion;
                        if(deda=="") deda="0";
                        if(dedb=="") dedb="0";                        
                        mesStruct[m].persona[k].dedicacion= parseFloat(deda)+parseFloat(dedb);
                        mesStruct[m].persona[k].original= parseFloat(deda)+parseFloat(dedb);
                        esta=true;
                    }
                }
                }catch(err){
                    console.log("ERROR",m);
                    console.log(i,datarr[i].equipo);
                    //console.log(mesStruct[m]);
                }
                if(vacio || !esta){
                    mesStruct[m].persona.push({nombre:datarr[i].equipo[j].nombre,dedicacion:datarr[i].equipo[j].dedicacion});
                }
            }
        }
    }
    for(let r in mesStruct){
        if(mesStruct[r]!= ""){
            //console.log("r",mesStruct[r].mes)
            //var m=parseInt(r)+1;
            var m=mesStruct[r].mes;
            var id="mes"+parseInt(m)+"totales";
            //console.log("mon",id);
            var mon=document.getElementById(id);
            var rec=document.createElement("button");
            rec.type="button";
            rec.id="b-mes"+parseInt(m);
            var texto=document.createTextNode("Recalcular");
            rec.appendChild(texto);
            //mon.appendChild(rec);
            //
            /*document.getElementById(rec.id).addEventListener("click", function() {
                var dat=this.id.split("-");
                recalcular(dat[1]);
            });*/
            var pers=mesStruct[r].persona
            for(let p in pers){
                var div=document.createElement("div");
                var clase="good";
                if(pers[p].dedicacion>GOODTHRESHOLD){
                    clase="bad";
                }
                div.className="cardmini "+clase;                    
                //var texto=document.createTextNode(pers[p].nombre+" -->"+pers[p].dedicacion);
                var sp1=document.createElement("span");
                var sp2=document.createElement("input");
                var sp3=document.createElement("span");
                var nb=document.createTextNode(pers[p].nombre);
                //var dedica=document.createTextNode(pers[p].dedicacion);
                var por=document.createTextNode("%");
                sp1.appendChild(nb);
                //sp2.appendChild(dedica);
                sp2.value=pers[p].dedicacion
                sp3.appendChild(por);
                sp1.className="nb";
                sp2.className="dedi";
                sp2.readOnly="true";
                sp2.id="sp-"+pers[p].nombre+"-"+m;
                div.appendChild(sp1);
                div.appendChild(sp2);
                div.appendChild(sp3);
                mon.appendChild(div);                
            }
        }
    }
}


function addElementIntoTeamStruct(tsnombre){
    var partesNombre=tsnombre.split("-");
    //console.log("addElementIntoTeamStruct",partesNombre);
    tsnombre=partesNombre[1];
    var contenedor=document.getElementById("team");
    var div=document.createElement("div");
    div.id="t-"+tsnombre;
    var inp=document.createElement("input");
    inp.type="text";
    inp.name="nombre"
    inp.readOnly="true";
    //inp.style.width="120px";
    inp.value=tsnombre;
    inp.className="name";
    var inp2=document.createElement("input");
    inp2.type="text";
    inp2.style.width="30px"
    inp2.name=tsnombre;
    inp2.value=0;
    div.draggable="true";
    div.className="card";
    div.ondragstart=drag;
    div.appendChild(inp);
    div.appendChild(inp2);        
 
    var botonfiltro=document.createElement("button");
    botonfiltro.type="button";
    botonfiltro.name="f-"+tsnombre;
    botonfiltro.id="f-"+tsnombre;        

    var textofiltro=document.createTextNode("f");
    botonfiltro.appendChild(textofiltro);
    //div.appendChild(boton);
    div.appendChild(botonfiltro);
    contenedor.appendChild(div);

    document.getElementById(botonfiltro.id).addEventListener("click", function() {
        var dat=this.name.split("-");
        var tit=this.innerHTML;
        document.getElementById("projectsBox").value="Seleccione...";
        if(tit=="f"){
            setVisibilityToProy(dat[1],true);
            this.innerHTML="b";
        }else{
            setVisibilityToProy("",false);
            this.innerHTML="f";
        }

    });
}
function createTeamStruct(){
    var contenedor=document.getElementById("team");
    for(let j in teamStruct){
        var div=document.createElement("div");
        div.id="t-"+teamStruct[j].name;
        var inp=document.createElement("input");
        inp.type="text";
        inp.name="nombre"
        inp.readOnly="true";
        //inp.style.width="120px";
        inp.value=teamStruct[j].name;
        inp.className="name";
        var inp2=document.createElement("input");
        inp2.type="text";
        inp2.style.width="30px"
        inp2.name=teamStruct[j].name;
        inp2.value=0;
        div.draggable="true";
        div.className="card";
        div.ondragstart=drag;
        div.appendChild(inp);
        div.appendChild(inp2);        
        var boton=document.createElement("button");
        boton.type="button";
        boton.name="b-"+teamStruct[j].name;
        boton.id="b-"+teamStruct[j].name;
        var botonfiltro=document.createElement("button");
        botonfiltro.type="button";
        botonfiltro.name="f-"+teamStruct[j].name;
        botonfiltro.id="f-"+teamStruct[j].name;        
        var texto2=document.createTextNode("+");
        boton.appendChild(texto2);
        var textofiltro=document.createTextNode("f");
        botonfiltro.appendChild(textofiltro);
        //div.appendChild(boton);
        div.appendChild(botonfiltro);
        contenedor.appendChild(div);
        /*document.getElementById(boton.id).addEventListener("click", function() {
            var dat=this.name.split("-");
            if(dat[0]=="b"){
                alert("Arrastre el consultor hacia un proyecto")
            }else{
                BotonDuplicar(dat[1], dat[2], dat[0]);
            }
        });*/
        document.getElementById(botonfiltro.id).addEventListener("click", function() {
            var dat=this.name.split("-");
            var tit=this.innerHTML;
            document.getElementById("projectsBox").value="Seleccione...";
            if(tit=="f"){
                setVisibilityToProy(dat[1],true);
                this.innerHTML="b";
            }else{
                setVisibilityToProy("",false);
                this.innerHTML="f";
            }

        });
    }
}
function mostrarProyMonthly(pproy){
    var contenedor = document.getElementById("tab-proj-01");
    var rowHead=`<thead><tr><th>Cod</th><th>Nombre</th><th>Fase</th><th>Ene</th><th>Feb</th><th>Mar</th><th>Abr</th><th>May</th><th>Jun</th><th>Jul</th><th>Ago</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dic</th><th>Ene_</th><th>Feb_</th><th>Mar_</th><th>Abr_</th><th>A</th></tr></thead>`;
    var rowName=['<thead><tr><th width="40px" style="width:40px">ID</th><th style="width:420px">Nombre</th><th style="width:20px">Fase</th><th style="width:80px">Inicio</th><th style="width:80px">Cierre</th>','<th>Ene</th>','<th>Feb</th>','<th>Mar</th>','<th>Abr</th>','<th>May</th>','<th>Jun</th>','<th>Jul</th>','<th>Ago</th>','<th>Sep</th>','<th>Oct</th>','<th>Nov</th>','<th>Dic</th>','<th>Ene_</th>','<th>Feb_</th>','<th>Mar_</th>','<th>Abr_</th>','<th>May_</th>','<th>Jun_</th>','<th>Jul_</th>','<th>Ago_</th>','<th>Sep_</th>','<th>Oct_</th>','<th>Nov_</th>','<th>Dic_</th>']
    contenedor.innerHTML=rowHead;
    var rows="";
    //console.log("factprojmonthy",factprojmonthy)
    var arr=factprojmonthy;
    //console.log("data arr",arr)
    var rowHead=rowName[0];
    for(let m=INITIALMONTH;m<INITIALMONTH+MONTHTOSHOW;m++){
        rowHead=rowHead+rowName[m];
    }
    rowHead=rowHead+"</tr></thead>"
    
    for(let i in arr){         
        if(arr[i].proyecto==pproy||pproy==0){
            var tds=[];
            tds.push(`<tr><td>${arr[i].proyecto}</td><td>${arr[i].nb_proyecto}</td><td>${arr[i].fase}</td><td>${(arr[i].inicio?arr[i].inicio.substring(0,10):'')}</td><td>${(arr[i].cierre?arr[i].cierre.substring(0,10):'')}</td>`)
            tds.push(`<td >${(arr[i].pEne?'Avg: '+arr[i].pEne.toFixed(1)+'%':'')}<br>${(arr[i].hEne?arr[i].hEne.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pfeb?'Avg: '+arr[i].pfeb.toFixed(1)+'%':'')}<br>${(arr[i].hfeb?arr[i].hfeb.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pmar?'Avg: '+arr[i].pmar.toFixed(1)+'%':'')}<br>${(arr[i].hmar?arr[i].hmar.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pabr?'Avg: '+arr[i].pabr.toFixed(1)+'%':'')}<br>${(arr[i].habr?''+arr[i].habr.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pmay?'Avg: '+arr[i].pmay.toFixed(1)+'%':'')}<br>${(arr[i].hmay?arr[i].hmay.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pjun?'Avg: '+arr[i].pjun.toFixed(1)+'%':'')}<br>${(arr[i].hjun?arr[i].hjun.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pjul?'Avg: '+arr[i].pjul.toFixed(1)+'%':'')}<br>${(arr[i].hjul?arr[i].hjul.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pago?'Avg: '+arr[i].pago.toFixed(1)+'%':'')}<br>${(arr[i].hago?arr[i].hago.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].psep?'Avg: '+arr[i].psep.toFixed(1)+'%':'')}<br>${(arr[i].hsep?arr[i].hsep.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].poct?'Avg: '+arr[i].poct.toFixed(1)+'%':'')}<br>${(arr[i].hoct?arr[i].hoct.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pnov?'Avg: '+arr[i].pnov.toFixed(1)+'%':'')}<br>${(arr[i].hnov?arr[i].hnov.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pdic?'Avg: '+arr[i].pdic.toFixed(1)+'%':'')}<br>${(arr[i].hdic?arr[i].hdic.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pEne_?'Avg: '+arr[i].pEne_.toFixed(1)+'%':'')}<br>${(arr[i].hEne_?arr[i].hEne_.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pfeb_?'Avg: '+arr[i].pfeb_.toFixed(1)+'%':'')}<br>${(arr[i].hfeb_?arr[i].hfeb_.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pmar_?'Avg: '+arr[i].pmar_.toFixed(1)+'%':'')}<br>${(arr[i].hmar_?arr[i].hmar_.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pabr_?'Avg: '+arr[i].pabr_.toFixed(1)+'%':'')}<br>${(arr[i].habr_?arr[i].habr_.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pmay_?'Avg: '+arr[i].pmay_.toFixed(1)+'%':'')}<br>${(arr[i].hmay_?arr[i].hmay_.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pjun_?'Avg: '+arr[i].pjun_.toFixed(1)+'%':'')}<br>${(arr[i].hjun_?arr[i].hjun_.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pjul_?'Avg: '+arr[i].pjul_.toFixed(1)+'%':'')}<br>${(arr[i].hjul_?arr[i].hjul_.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].pago_?'Avg: '+arr[i].pago_.toFixed(1)+'%':'')}<br>${(arr[i].hago_?arr[i].hago_.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].psep_?'Avg: '+arr[i].psep_.toFixed(1)+'%':'')}<br>${(arr[i].hsep_?arr[i].hsep_.toFixed(1)+' Hrs':'')}</td>`);
            tds.push(`<td>${(arr[i].poct_?'Avg: '+arr[i].poct_.toFixed(1)+'%':'')}<br>${(arr[i].hoct_?arr[i].hoct_.toFixed(1)+' Hrs':'')}</td>`);
            //if(pproy!=0) console.log("tds",tds);
            rows=rows+tds[0];
            for(let j=INITIALMONTH;j<INITIALMONTH+MONTHTOSHOW;j++){
                if(typeof tds[j]!="undefined" )
                    rows=rows+tds[j];
            }
            
            
        }
    }
    contenedor.innerHTML=rowHead+rows;
    //console.log("contenedor height",contenedor.offsetHeight+" "+contenedor.style.height)
}

let asynGetFromDB = async (url) => { 
    const fetchData= await fetch(url, {
        method: 'GET',
        headers: {
            //'Content-Type': 'application/x-www-form-urlencoded',
            'Content-Type': 'application/json',
        }
    }).then(r => r.json()).catch((error) => {
        console.error(error);
    });
    return fetchData;
}
function setProy(){    
    createBaseTable();

    asynGetFromDB(`https://getstaffinghttp.azurewebsites.net/api/getstaffinghttp`).then(function(fetchData){
        //console.log("fetch data",fetchData);
        buildProject(fetchData.data)
        //createMonStruct(dataArr);
        createMonStruct(fetchData.data);
        })

        
    
    asynGetFromDB(`https://getconsultant.azurewebsites.net/api/getconsultant`).then(function(fetchData){
        //console.log("fetch data",fetchData);
        teamStruct=fetchData.data
        teamStruct.push(setDataTeam("CAMILO MORENO",0));
        teamStruct.push(setDataTeam("OLENA VARZAR",0));
        createTeamStruct();
    })

    asynGetFromDB(`https://getallprojects.azurewebsites.net/api/getallprojects`).then(function(fetchData){
        //console.log("fetch data getAllProjects",fetchData);
        var xPB = document.getElementById("projectsBox");
        

        for(let i in fetchData.data){
            var opt = document.createElement("option");
            opt.text = fetchData.data[i].proyecto+"-"+fetchData.data[i].nb_proyecto
            opt.value = fetchData.data[i].proyecto;
            xPB.options.add(opt, 1);
        }

    })
    //https://getfactprojmonthy.azurewebsites.net/api/getfactprojmonthy
    asynGetFromDB(`https://getfactprojmonthy.azurewebsites.net/api/getfactprojmonthy`).then(function(fetchData){
        //console.log("fetch data getAllProjects",fetchData);
        factprojmonthy=fetchData.data;
        mostrarProyMonthly(0);
    })
    asynGetFromDB(`https://getprojectsummary.azurewebsites.net/api/getprojectsummary`).then(function(fetchData){
        //console.log("fetch data getProjectSummary",fetchData);
        var breakProj="";
        var objProj={id:0,total_hrs:0,total_week:0,calendar_week:0,fases:[]}
        var tot_hrs=0;
        var tot_week=0;
        var cal_week=0;
        
        var fases=[]
        var projArr = fetchData.data;
        var prj=0;
        for(let i in projArr){
            //console.log(i,projArr[i]);
            if(breakProj==projArr[i].proyecto){
                //totalizar
                tot_hrs=tot_hrs+parseFloat(projArr[i].horas);
                tot_week=tot_week+parseFloat(projArr[i].semanas);
                if(!isNaN(parseFloat(projArr[i].dura_sem)))
                    cal_week=cal_week+parseFloat(projArr[i].dura_sem);
                fases.push({fase:projArr[i].Fase,hrs:projArr[i].horas,weeks:projArr[i].semanas,dura_sem:projArr[i].dura_sem})
            }else{
                //rompe
                if(breakProj==""){
                    //primer ciclo
                    breakProj=projArr[i].proyecto;
                    fases.push({fase:projArr[i].Fase,hrs:projArr[i].horas,weeks:projArr[i].semanas,dura_sem:projArr[i].dura_sem})
                    //console.log("breakProj",breakProj);
                    //console.log("1era vez ",fases);
                }else{
                    //subsiguientes
                    var phase=fases;
                    var projObj={id:breakProj,total_hrs:tot_hrs,total_week:tot_week,calendar_week:cal_week,fases:phase}
                    projStrtSumm.push(projObj);
                    breakProj=projArr[i].proyecto;
                    //console.log("breakProj",breakProj);
                    //console.log("rompe",projStrtSumm);
                    fases=[];
                    fases.push({fase:projArr[i].Fase,hrs:projArr[i].horas,weeks:projArr[i].semanas,dura_sem:projArr[i].dura_sem})
                    prj++;
                }
                tot_hrs=parseFloat(projArr[i].horas);
                tot_week=parseFloat(projArr[i].semanas);
                if(!isNaN(parseFloat(projArr[i].dura_sem)))
                    cal_week=parseFloat(projArr[i].dura_sem);
            }
        }
        //console.log("projStrtSumm",projStrtSumm);
       // fillProjSumm(40);
    })
}
/*
calendar_week: 14
fases: Array(3)
0: {fase: 1, hrs: 480, weeks: 12, dura_sem: 7}
1: {fase: 2, hrs: 496, weeks: 12.4, dura_sem: 7}
2: {fase: 3, hrs: 811.22222, weeks: 20.28056, dura_sem: null}
length: 3
[[Prototype]]: Array(0)
id: 40
total_hrs: 1787.22222
            <tr>
                <td>ID</td>
                <td>Fase</td>
                <td>Total Horas</td>
                <td>Total Semanas</td>
                <td>Semans Calendario</td>
                <td>Total</td>
            </tr>*/
function headTable(tabla){
    var fila1=document.createElement("TR");
    var hd=document.createElement("thead")
    //  crear columnas
    var idCol1=document.createElement("TD");
    var faseCol1=document.createElement("TD");
    var totHrsCol1=document.createElement("TD");
    var totWeeksCol1=document.createElement("TD");
    var totDuraWeekCol1=document.createElement("TD");
    var idCol_tx1 = document.createTextNode("ID");
    var faseCol_tx1 = document.createTextNode("Fase");
    var totHrsCol_tx1 = document.createTextNode("Total Horas");
    var totWeeksCol_tx1=document.createTextNode("Total Semanas");
    var totDuraWeekCol_tx1=document.createTextNode("Semanas Calendario");
    idCol1.appendChild(idCol_tx1);
    faseCol1.appendChild(faseCol_tx1);
    totHrsCol1.appendChild(totHrsCol_tx1);
    totWeeksCol1.appendChild(totWeeksCol_tx1);
    totDuraWeekCol1.appendChild(totDuraWeekCol_tx1);
    fila1.appendChild(idCol1);
    fila1.appendChild(faseCol1);
    fila1.appendChild(totHrsCol1);
    fila1.appendChild(totWeeksCol1);
    fila1.appendChild(totDuraWeekCol1);
    hd.appendChild(fila1)
    tabla.appendChild(hd);
}
function fillProjSumm(projId){
    //   traer tabla
    var tabla=document.getElementById("projSumm");
    tabla.innerHTML = "";
    if(projId!="Seleccione...")
        headTable(tabla)
    for( let i in projStrtSumm){
        if(projStrtSumm[i].id==projId){
            let f=projStrtSumm[i].fases
            for(let j in f){
                //  agregar filas de tablas
                var fila=document.createElement("TR");
                //  crear columnas
                var idCol=document.createElement("TD");
                var faseCol=document.createElement("TD");
                var totHrsCol=document.createElement("TD");
                var totWeeksCol=document.createElement("TD");
                var totDuraWeekCol=document.createElement("TD");
                var idCol_tx = document.createTextNode(projStrtSumm[i].id);
                var faseCol_tx = document.createTextNode(f[j].fase);
                //
                //(!f[j].hrs ? f[j].hrs : f[j].hrs.toFixed(2))
                //(isNaN(f[j].dura_sem) ? f[j].dura_sem : f[j].dura_sem.toFixed(2))
                //console.log(!f[j].dura_sem,(!f[j].dura_sem ? f[j].dura_sem : f[j].dura_sem.toFixed(2)))
                var totHrsCol_tx = document.createTextNode((!f[j].hrs ? f[j].hrs : f[j].hrs.toFixed(2)));
                var totWeeksCol_tx=document.createTextNode((!f[j].weeks ? f[j].weeks : f[j].weeks.toFixed(2)));
                var totDuraWeekCol_tx=document.createTextNode((!f[j].dura_sem ? f[j].dura_sem : f[j].dura_sem.toFixed(2)));
                idCol.appendChild(idCol_tx);
                faseCol.appendChild(faseCol_tx);
                totHrsCol.appendChild(totHrsCol_tx);
                totWeeksCol.appendChild(totWeeksCol_tx);
                totDuraWeekCol.appendChild(totDuraWeekCol_tx);
                fila.appendChild(idCol);
                fila.appendChild(faseCol);
                fila.appendChild(totHrsCol);
                fila.appendChild(totWeeksCol);
                fila.appendChild(totDuraWeekCol);
                tabla.appendChild(fila);
            }
            //  agregar filas de tablas
            var fila1=document.createElement("TR");
            //  crear columnas
            var idCol1=document.createElement("TD");
            var faseCol1=document.createElement("TD");
            var totHrsCol1=document.createElement("TD");
            var totWeeksCol1=document.createElement("TD");
            var totDuraWeekCol1=document.createElement("TD");
            var idCol_tx1 = document.createTextNode("Total:");
            var faseCol_tx1 = document.createTextNode(f.length);
            var totHrsCol_tx1 = document.createTextNode(projStrtSumm[i].total_hrs.toFixed(2));
            var totWeeksCol_tx1=document.createTextNode(projStrtSumm[i].total_week.toFixed(2));
            var totDuraWeekCol_tx1=document.createTextNode(projStrtSumm[i].calendar_week.toFixed(2));
            idCol1.appendChild(idCol_tx1);
            faseCol1.appendChild(faseCol_tx1);
            totHrsCol1.appendChild(totHrsCol_tx1);
            totWeeksCol1.appendChild(totWeeksCol_tx1);
            totDuraWeekCol1.appendChild(totDuraWeekCol_tx1);
            fila1.appendChild(idCol1);
            fila1.appendChild(faseCol1);
            fila1.appendChild(totHrsCol1);
            fila1.appendChild(totWeeksCol1);
            fila1.appendChild(totDuraWeekCol1);
            tabla.appendChild(fila1);
        } 
    }
    //console.log("projSumm",tabla.offsetHeight)
    return tabla.offsetHeight;
}
function filtrarPorProyecto(){
    var proyId = document.getElementById("projectsBox").value;
    //console.log("selected "+proyId);
    var ht=parseInt(fillProjSumm(proyId));
    ht = ht + 40;
    if(ht>40)
        document.getElementById("div-content-head").style.height=ht+"px";
    else
    document.getElementById("div-content-head").style.height="120px";
    var classProjArr = document.getElementsByClassName("proyecto");
    if(proyId=="Seleccione..."){
        for(let ii in classProjArr){
            if(typeof classProjArr[ii].id!="undefined"){
                classProjArr[ii].style.display="block";  // mostrar el proyecto buscado
            }
        }
        mostrarProyMonthly(0);
    }else{ 
        var encontrado=false;
        var idProj=0;
        for(let i in classProjArr){
            if(typeof classProjArr[i].id!="undefined"){
                let id = classProjArr[i].id;
                let pos = id.indexOf(".");
                idProj=id.substring(0,pos);
                //console.log("filtrarPorProyecto",idProj)
                if(idProj!=proyId){
                    classProjArr[i].style.display="none";  // ocultar los distintos al proyecto buscado
                }else{
                    classProjArr[i].style.display="block";  // mostrar el proyecto buscado
                    encontrado=true;
                    
                }
            }
        }
        if(encontrado){
            var contenedor = document.getElementById("container-project");
            contenedor.style.display=""
            mostrarProyMonthly(proyId);
        }
            
    }
}
function mostrar() {
    //console.log("mostrar");
    document.getElementById("sidebar").style.width = "200px";
    document.getElementById("contenido").style.marginLeft = "200px";
    document.getElementById("tab-proj-01").style.marginLeft = "200px";
    //console.log("margin",document.getElementById("tab-proj-01").style.marginLeft)
    document.getElementById("abrir").style.display = "none";
    document.getElementById("cerrar").style.display = "inline";
}

function ocultar() {
    //console.log("ocultar");
    document.getElementById("sidebar").style.width = "0";
    document.getElementById("contenido").style.marginLeft = "0";
    document.getElementById("tab-proj-01").style.marginLeft = "0";
    //console.log("margin",document.getElementById("tab-proj-01").style.marginLeft)
    document.getElementById("abrir").style.display = "inline";
    document.getElementById("cerrar").style.display = "none";
}
function showContainerProj(){
    let btn=document.getElementById("btn-hojas");
    if(document.getElementById("contenido").style.display==""){
        document.getElementById("contenido").style.display="none";
        document.getElementById("container-project").style.display="";
        btn.textContent="Staffing View"
    }else{
        document.getElementById("contenido").style.display="";
        document.getElementById("container-project").style.display="none";
        btn.textContent="Project View"
    }

}
//showContainerBoth
function showContainerBoth(){
    let btn=document.getElementById("btn-both");
    if(btn.textContent=="Project View & Staffing View"){
        document.getElementById("contenido").style.display="";
        document.getElementById("container-project").style.display="";
        btn.textContent="Hide Project View"
    }else{
        document.getElementById("contenido").style.display="";
        document.getElementById("container-project").style.display="none";
        btn.textContent="Project View & Staffing View"
    }

}
async function sendData(objToSend){
    //console.log("sendData",JSON.stringify(objToSend));
    const fetchDetail = fetch(`https://setstaffinghttp.azurewebsites.net/api/setstaffinghttp`, {
        method: 'POST',
        body:JSON.stringify(objToSend),
        headers: {
            //'Content-Type': 'application/x-www-form-urlencoded',
            'Content-Type': 'application/json',
        }
    }).then(r => r.json()).catch((error) => {
        console.error(error);
    });
    return fetchDetail;
}
function sendToServer(){
    var modifyData=[];
    var hayData=false;
    for(let i in dataArr){
        if(dataArr[i].dirty==1){
            var mod=dataArr[i];
            //console.log("modificar",dataArr[i].dedicacion)
            modifyData.push(mod);
            hayData=true;
        }
    }
    if(hayData){
        var objToSend={data:modifyData}
        //console.log("enviar a server",objToSend);
        sendData(objToSend).then((fetchDetail)=>{  
            //console.log("retorno fetchdetail",fetchDetail);
            //var ret= JSON.parse(fetchDetail);
            //console.log("fetchDetail",fetchDetail.code)
            if(fetchDetail.code==0){
                //console.log("entro a limpiar dirty")
                // si todo ok, poner dirty en 0
                // esto permite que se no se reprocesen cambios a la base de datos que ya se ejecutaron
                for(let i in dataArr){
                    if(dataArr[i].dirty==1){
                        dataArr[i].dirty=0;
                    }
                } 
                alert("La información se actualizó exitosamente");
               // Response: "{ "status": "cambio en dedicacion errado", "code": 1, "orig": 42.86, "chg": 22.86 }"
            }else alert("No se pudo realizar la actualizacion, debido a que la dedicación original no está cubierta con los cambios. Valor original "+fetchDetail.orig+" cambio por "+fetchDetail.chg)
        });
    }else alert("No se ha modificado datos");
    /*
    var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance 
    xmlhttp.open("POST", "/json-handler");
    xmlhttp.setRequestHeader("Content-Type", "application/json");
    xmlhttp.send(JSON.stringify({name:"John Rambo", time:"2pm"}));
    */
}

</script>
</head>
<body>

<div id="div-content-head" style="width: 100%;height:120px;background-color:#9999ff">&nbsp;
    <div style="float: left;">
        <img src="image/cybs-llogo-new-blanco.png" style="padding-top: 15px;" width="80px"></img>
    </div>
    <div style="float: left;width:300px;margin-left: 130px;">
        <span style="width: 600px;text-align: left;"><h2 style="color:white">Staffing v0.9</h2></span>
    </div>
    <div>
        <table id="projSumm" style="margin-left: 300px;" class="paleBlueRows">

        </table></div>
    
</div>
<input type="checkbox" id="abrir-cerrar" name="abrir-cerrar" value="">
<label for="abrir-cerrar">☰ <span class="abrir">Abrir</span><span class="cerrar">Cerrar</span>&nbsp;&nbsp;
    <button type="button" style="color:white" onclick="sendToServer()">Save</button>|
    <button type="button" id="btn-hojas" style="color:white" onclick="showContainerProj()">Project View</button>
    <button type="button" id="btn-both" style="color:white" onclick="showContainerBoth()">Project View & Staffing View</button>
</label>

<div id="sidebar" class="sidebar">
    <img src="image/cybs-llogo-new-blanco.png" width="80px"></img>
    <div class="totales">
        <div>Project Filter</div>
        <select id="projectsBox" onchange="filtrarPorProyecto()" style="width: 185px;height: 30px;">
            <option>Seleccione...</option>
        </select>
    </div>
    <div style="text-align: center;">  <h4 style="color:white">CYBS Team</h4></div>

    <div id="trash"  ondrop="drop2(event)" ondragover="allowDrop(event)" style="border:1px solid #a31aff;color:#f5e6ff; width: 90%; height: 100px; ">
        <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" overflow="hidden"><defs><clipPath id="clip0"><rect x="592" y="312" width="40" height="40"/></clipPath><clipPath id="clip1"><rect x="592" y="312" width="39" height="39"/></clipPath><clipPath id="clip2"><rect x="592" y="312" width="39" height="39"/></clipPath><clipPath id="clip3"><rect x="592" y="312" width="39" height="39"/></clipPath></defs><g clip-path="url(#clip0)" transform="translate(-592 -312)"><g clip-path="url(#clip1)"><g clip-path="url(#clip2)"><g clip-path="url(#clip3)"><path d="M623.688 320.125 616.781 320.125 616.781 318.094C616.781 316.509 615.522 315.25 613.938 315.25L609.062 315.25C607.478 315.25 606.219 316.509 606.219 318.094L606.219 320.125 599.312 320.125C598.419 320.125 597.688 320.856 597.688 321.75L597.688 323.375 625.312 323.375 625.312 321.75C625.312 320.856 624.581 320.125 623.688 320.125ZM608.656 318.094C608.656 317.85 608.819 317.688 609.062 317.688L613.938 317.688C614.181 317.688 614.344 317.85 614.344 318.094L614.344 320.125 608.656 320.125 608.656 318.094Z" fill="#FFFFFF" fill-rule="nonzero" fill-opacity="1"/><path d="M600.125 346.125C600.125 347.019 600.856 347.75 601.75 347.75L621.25 347.75C622.144 347.75 622.875 347.019 622.875 346.125L622.875 325 600.125 325 600.125 346.125ZM616.781 327.438 619.219 327.438 619.219 345.312 616.781 345.312 616.781 327.438ZM610.281 327.438 612.719 327.438 612.719 345.312 610.281 345.312 610.281 327.438ZM603.781 327.438 606.219 327.438 606.219 345.312 603.781 345.312 603.781 327.438Z" fill="#FFFFFF" fill-rule="nonzero" fill-opacity="1"/></g></g></g></g></svg>
    </div>

    <div id="team">

    </div>

</div>
<div id="container-project" style="display: none;">
    <div style="font-family: Verdana, Geneva, Tahoma, sans-serif;font-size: 10pt;padding-top:10px;padding-bottom: 10px;">
        <b>PROJECT VIEW</b><br>
        Promedio de dedicación del equipo, Total horas
    </div>
    <table id="tab-proj-01" class="paleBlueRows" style="width:75%" >

    </table>
</div>
<div id="contenido" >
    <div style="font-family: Verdana, Geneva, Tahoma, sans-serif;font-size: 10pt;padding-top:10px;padding-bottom: 10px;">
        <b>STAFFING VIEW</b>
    </div>
    <div id="bar"  style="z-index: 20;height:0;width:0;background-color:#fff2e6;top:0;left:0;position: fixed;
transition: height 1s;"></div>
    <div id="div3" style="display: none;" ></div>
</div>

    <script>setProy();
    window.addEventListener('resize', function(event) {
    document.getElementById("bar").style.marginLeft=(window.innerWidth-400)+"px";
    document.getElementById("bar").style.height=window.window.innerHeight+"px"
}, true);   
    </script>
</body>
</html>
